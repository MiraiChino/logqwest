# Logqwest - LLM駆動型 放置型テキストゲーム コンテンツ自動生成ツール

Logqwestは、大規模言語モデル（LLM）を活用した放置型テキストゲームです。このリポジトリは、Logqwestのゲームコンテンツ（冒険シナリオ、エリア情報、ログデータなど）をLLMによって自動生成するツールを提供します。StreamlitによるGUIを通じて、生成されたコンテンツの閲覧、管理、編集が可能です。

## 特徴

- **自動コンテンツ生成**: LLMを活用し、エリア、冒険、ログ、位置情報などのゲームコンテンツを自動生成します。
- **LLMの選択**: GeminiとOpenRouterのLLMをサポートし、コマンドライン引数で簡単に切り替え可能です。
- **GUI**: Streamlitによる直感的で使いやすいGUIを提供し、生成されたコンテンツの確認や管理を容易にします。
- **カスタマイズ**: テンプレートや設定ファイルを編集することで、生成されるコンテンツのスタイルや内容をカスタマイズできます。
- **データ管理**: 生成されたデータはCSVファイルとして保存され、容易にアクセスや編集が可能です。
- **ゲーム体験**: 生成されたデータを利用して、簡単なゲームプレイを体験できます。

## ゲームの概要とルール

Logqwestは、LLMを活用した放置型ファンタジー冒険ゲームです。プレイヤーは有限の資金を運用し、冒険者を雇い財宝を狙う冒険に出発させます。生成されたコンテンツは現実世界と連動したゲームプレイを実現します。

### ゲームルール

- **プレイヤーの行動**  
  冒険ごとに100Gを出資し冒険者を雇います。冒険中はプレイヤーによる選択肢操作は不要で、結果を待機します。
- **ゲームの循環構造**  
  資金が0になるとゲームオーバーとなるため、**残高管理が重要**です。  
  100G出資→冒険実行→結果待ち→成功時アイテム売却→資金増加→再出資という  
  経済ループを維持しながらゲームを進めます。99.5%の還元率により、  
  長期的な資金運用が可能ですが、確率的な失敗（50%）が連続すると  
  ゲームオーバーに至ります（`src/app.py`のbalance管理を参照）。

- **ストーリーの多様性**  
  - **大成功時**: 財宝発見が世界規模のイベントを発生させ、  
    例えば通貨価値の変動や新エリアの公開が促進される（`prompt/new_adventure.txt`のresult_template実装）  
  - **成功時**: 50種類以上のアイテムを生成（`prompts/config.json`参照）、  
    `src/ui/views/adventure_detail.py`のsell_buttonで売却価格確認  
  - **失敗時**: 5段階の損失度合い（軽微/中度/重度/致命的/帰還不能）を  
    LLMがランダム生成。帰還不能時は`st.session_state.running_adventure = False`で  
    プレイヤーに明示的に通知されます。

- **UI操作とストーリー連携**  
  冒険詳細画面（`src/ui/views/adventure_detail.py`）で  
  取得したアイテムを一覧表示し、売却ボタンを配置。  
  地図表示は`location.txt`の生成内容に基づき、  
  ストーリーの進行に応じて動的に更新されます。

- **セーブデータの特徴**  
  `user_data/history.json`はリアルタイム更新され、  
  プレイヤーがページをリロードしてもゲーム状態が維持されます。  
  冒険中は`running_adventure`フラグがTrueに設定され、  
  バックグラウンドで進捗が管理されます（`src/app.py`を参照）。

- **冒険結果と経済バランス**  
  - **大成功 (5%)**：1000Gの収益（5倍の還元）  
  - **成功 (45%)**：110Gの収益（10%の利益）  
  - **失敗 (50%)**：0Gの損失  
  - **還元率**：99.5%（長期的にほぼ資金を維持可能）

- **アイテムの取り扱い**  
  成功時に得られるアイテムは売却可能で、売却価格はステータス画面で確認できます（`src/ui/views/adventure_detail.py`実装）。

### 冒険システム

- **エンジン設計**  
  [`src/generators`](src/generators)モジュールで生成される50～200行のテキストイベント。各エリアで個別のシナリオが展開されます。

- **冒険の連鎖性**
  - **独立型冒険**：過去の経験に左右されないスタンドアロンコンテンツ
  - **関連型冒険**：`prev_adventure_name`パラメータにより過去の冒険結果と連動（[`Adventure`](src/utils/commands.py:24)データクラス実装）
  - **物語の連続性と深掘り**:
    - 過去の冒険ログから抽出される「物理的痕跡」と「世界への影響」が、単なる描写に留まらず、現在の冒険者の行動や今後の物語展開に影響を与える具体的なフックとして機能するよう、LLMへの指示を強化しました。
    - これにより、プレイヤーは過去の出来事が現在の世界にどのように影響しているかをより明確に感じ取ることができ、物語への没入感が深まります。
  - **サプライズと伏線の強化**:
    - 新しい冒険の生成において、過去の先駆者の痕跡や影響を、物語の「サプライズ」や「伏線」のトリガーとして積極的に活用するようLLMに促しています。
    - プレイヤーは、過去の冒険で何気なく見過ごした情報や出来事が、現在の冒険で予想外の形で再登場し、物語の展開に大きな影響を与える体験をすることができます。これにより、「あの時の行動がここに影響しているのか！」という発見と驚きが生まれ、物語の連続性が強調されます。

- **状態遷移**  
  冒険結果（大成功/成功/失敗）に応じて：
  - 財宝発見 → 世界に影響を与えるイベント付加（`result_template`参照）
  - 手頃なアイテム取得 → 売却可能素材
  - 冒険継続不可能 → プレイヤー帰還なし

### 進捗管理

- **永続化設計**  
  ユーザーデータは`user_data/history.json`で管理され、残高と冒険履歴を保持（`src/utils/file_handler.py`実装）。
- **ゲーム状態**  
  - 冒険中：`st.session_state.running_adventure = True`（`src/app.py`参照）
- **過去の冒険依存の実装**  
  [`src/generators/extract.py`](src/generators/extract.py)のExtractorが過去の冒険ログを解析し、  
  特定の形式（`[影響要素]: [内容]`）で重要な出来事を抽出。この影響データを  
  [`src/generators/adventure.py`](src/generators/adventure.py:573)の`generate_new_locked_adventure()`  
  に渡して、新エリアへの連鎖性を実装しています。
  
  **具体例**: 前回の冒険で「毒の川を渡った」場合、  
  新エリア生成時に`[環境]: 毒を帯びた水流の影響で植物が変異`という  
  効果が自動的に反映されます（プロンプトテンプレート参照: `prompts/new_locked_adventure.txt`）

- **データ連動の階層構造**  
  ```mermaid
  flowchart LR
    A[冒険結果] -->|成功/失敗| B[エリア解放条件]
    B --> C[新エリア生成]
    C --> D[Extracted Impact Data]
    D --> E[次の冒険のプロンプト]
    E --> F[連続した世界観の構築]
  ```
  - バックグラウンド更新：`st.experimental_rerun()`によるリアルタイム反映

## 構成

```
src/
├── core/           # LLMクライアント、コンテンツ生成、検証の抽象化とインターフェース
├── generators/     # 各種コンテンツ生成モジュール（エリア、冒険、ログ、位置情報）
├── checkers/      # 生成されたコンテンツの検証モジュール
├── utils/         # ユーティリティ関数とヘルパー
├── ui/            # Streamlitインターフェースコンポーネント
├── generate.py     # コマンドラインからのコンテンツ生成スクリプト
├── app.py          # 生成されたデータを利用してゲームを体験
└── viewer.py       # 生成されたコンテンツの確認や管理を行うGUI
```

## 必要な環境

- Python 3.9+
- Gemini APIキー または OpenRouter APIキー

## セットアップ

1. 依存関係のインストール:

   ```bash
   pip install -r requirements.txt
   pip install -e .
   ```

2. APIキーの設定:

   Gemini APIキーまたはOpenRouter APIキーを環境変数に設定します。

   ```bash
   export GEMINI_API_KEY=your_gemini_api_key
   export OPENROUTER_API_KEY=your_openrouter_api_key
   ```

## 使い方

### Webインターフェース

- `app.py`: 生成されたデータを利用してゲームを体験できます。

   ```bash
   streamlit run src/app.py
   ```

- `viewer.py`: 生成されたコンテンツの確認や管理を行うGUIを提供します。

   ```bash
   streamlit run src/viewer.py
   ```

### コマンドライン

コマンドラインからコンテンツを生成します:

```bash
python src/generate.py area              # 新しいエリアを生成
python src/generate.py adventure        # 新しい冒険を生成
python src/generate.py log             # 冒険ログを生成
python src/generate.py location        # 位置情報を生成
```

## アーキテクチャ

### 全体構造
次の5つの主要なレイヤーで構成されています：

1. **CLIエントリーポイント** (`src/generate.py`)
   - コマンドライン引数の解析
   - 設定読み込みとロギング初期化
   - LLMクライアント生成とコマンドハンドラ設定

2. **コマンドハンドラ** (`src/utils/commands.py`)
   - コンテンツ生成と検証の調整
   - リトライ処理による堅牢なエラーハンドリング
   - ファイル操作・進捗管理・CSV操作を各ユーティリティに委譲

3. **コンテンツ処理レイヤー**
   - **ジェネレータ群** (`src/generators/`)
     - エリア/冒険/ログ/位置情報のLLM生成処理
   - **チェッカー群** (`src/checkers/`)
     - 生成されたコンテンツの品質検証機能

4. **ユーティリティレイヤー** (`src/utils/`)
   - 設定管理：パスやテンプレートの構成情報を管理
   - データ処理：CSVファイルの読み書きとソート機能
   - ログ処理：GENERATE/SUCCESS等のカスタムログレベル
   - 進捗管理：ファイル構成から各コンテンツの完了率を算出
   - ファイル操作：データフォルダ/チェック結果/user_data/history.jsonのCRUD操作
   - リトライ処理：指数バックオフとAPIレート制限の特別処理

5. **Streamlit UI** (`src/app.py`と`src/ui/`)
   - エントリーポイント：app.pyでクエリパラメータ(area/adv等)を解析
   - UI制御：UIControllerでビューのルーティングとナビゲーション
   - ビュー構成：エリア一覧/詳細と冒険詳細を各ビューで表示
   - サイドバー：history.jsonデータで冒険履歴へのリンクナビゲーション

### データフロー
1. CLIまたはUIからコマンドハンドラに処理要求
2. ジェネレータがLLMにプロンプト送信しコンテンツ生成
3. チェッカーが生成内容の品質検証とチェック結果保存
4. FileHandler経由でCSV/TXTファイルにデータ永続化
5. ProgressTrackerでファイル構成を解析して進捗管理
6. Loggerでプロセス状況をログ出力
7. UIではクエリパラメータに基づき必要なデータを読み込み表示

### エラーハンドリング
RetryDecoratorで全ジェネレータ/チェッカー処理をラップし、RateLimitExeededやRetryLimitExeeded等の例外発生時はLoggerで状況を記録。さらに自動再試行または適切な待機処理を実施することで堅牢な動作を保証しています。
- `--model model_name` でモデルを指定します。

## データ構造と関係性

このプロジェクトで使用される主要なデータファイルとその役割、および相互の関係性は以下の通りです。

### 1. エリアデータ (例: `data/lv1.csv`)

*   **内容**: 各エリアの地理的特徴、歴史や伝説、リスクや挑戦、財宝、財宝の隠し場所、採取できるアイテム、生息する危険な生物、生息する無害な生物、経由地候補、近くの街、移動路、休憩ポイントなどの詳細情報が含まれます。
*   **役割**: 冒険が行われる場所の背景情報を提供し、冒険テキストや冒険データで言及される一般的な用語（財宝、アイテム、生物など）の説明の主要なソースとなります。
*   **関係性**:
    *   `冒険データ` と `ログデータ` で言及されるエリアや用語の定義元となります。
    *   `ログデータ` 内の用語をハイライトする際に、その説明を取得するために参照されます。

### 2. 冒険データ (例: `data/水奏の窪地イュール/水奏の窪地イュール.csv`)

*   **内容**: 特定の冒険のシナリオ、結果（成功/失敗）、章ごとのテキスト、冒険中に獲得したアイテムなどが記録されます。
*   **役割**: 個々の冒険のストーリーラインと、その冒険で登場する固有のアイテムやイベントに関する情報を提供し、`ログデータ` の文脈を補完します。
*   **関係性**:
    *   `ログデータ` の各章のテキストと密接に関連し、冒険の具体的な内容を記述します。
    *   冒険固有のアイテムや用語の説明源となる可能性があります。

### 3. ログデータ (例: `data/水奏の窪地イュール/失敗1_水奏の窪地イュール.txt`)

*   **内容**: 冒険の進行状況を記述した、ユーザーが実際に読むテキストファイルです。各行が冒険の特定の時点での出来事を表します。
*   **役割**: ユーザーに冒険の物語を提示する主要なコンテンツです。このテキスト内の財宝、アイテム、生物、場所などの用語をハイライトし、クリック可能にすることで、ユーザーは詳細な説明をポップアップで確認できるようになります。
*   **関係性**:
    *   `エリアデータ` および `冒険データ` から抽出された用語の説明と連携し、インタラクティブな読書体験を提供します。
    *   `位置データ` と連携し、冒険の各時点での現在地をマップ上に表示します。

### 4. 位置データ (例: `data/水奏の窪地イュール/loc_失敗1_水奏の窪地イュール.txt`)

*   **内容**: `ログデータ` の各行に対応する冒険者の現在地（エリア名）が記録されたテキストファイルです。
*   **役割**: 冒険の進行に合わせて、冒険者の位置をマップ上に視覚的に表示するために利用されます。
*   **関係性**:
    *   `ログデータ` と行単位で対応しており、冒険のどの部分でどのエリアにいたかを示します。

## データ連携の概要

これらのデータは連携して、以下のようなユーザー体験を提供します。

```mermaid
graph TD
    A[エリアデータ] -->|用語定義| C[ログデータ]
    B[冒険データ] -->|冒険固有情報| C
    C -->|テキスト表示 & 用語ハイライト| D[ユーザーインターフェース (Streamlit)]
    E[位置データ] -->|現在地表示| D
    D -->|用語クリック| F[ポップアップ説明]
```